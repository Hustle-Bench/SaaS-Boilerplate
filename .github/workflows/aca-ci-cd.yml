name: Build & Deploy to Azure Container Apps

on:
  push:
    branches: [main] # run automatically on every push to main
  workflow_dispatch: # manual ‚ÄúRun workflow‚Äù button

# ---------- Global constants you‚Äôll reuse ----------
env:
  AZURE_LOCATION: canadacentral # change if your ACA is in another region
  CONTAINER_APP: app-saas # name of the Container App resource
  RESOURCE_GROUP: rg-saas # RG that holds the Container App
  REGISTRY: ${{ secrets.REGISTRY_LOGIN_SERVER }} # crsaas7700.azurecr.io

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Pull down your repo‚Äôs code
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Log in to Azure with the JSON you stored as AZURE_CREDENTIALS
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3Ô∏è‚É£ Run unit + e2e tests
      - name: Run unit + e2e tests
        env:                       # üëà  env block first
          CLERK_SECRET_KEY: dummy
          CLERK_API_KEY: dummy
          CLERK_PUBLISHABLE_KEY: dummy
        run: |
          echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY"   # quick proof
          npm run test:e2e

      # 3Ô∏è‚É£ Build ‚ûú push ‚ûú deploy in ONE step
      - uses: azure/container-apps-deploy-action@v1
        with:
          # --- WHICH IMAGE TO USE / BUILD ---------------------------
          appSourcePath: ${{ github.workspace }} # local Dockerfile build context
          acrName: crsaas7700 # registry name only
          acrUsername: ${{ secrets.REGISTRY_USERNAME }} # ACR admin user
          acrPassword: ${{ secrets.REGISTRY_PASSWORD }} # ACR admin password
          # ----------------------------------------------------------

          # Publish both a commit‚Äëspecific tag and the moving "latest" tag
          tags: |
            ${{ env.REGISTRY }}/app-saas:${{ github.sha }}
            ${{ env.REGISTRY }}/app-saas:latest

          containerAppName: ${{ env.CONTAINER_APP }}
          resourceGroup: ${{ env.RESOURCE_GROUP }}

          environmentVariables: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            NEXTAUTH_URL=https://${{ env.CONTAINER_APP }}.${{ env.AZURE_LOCATION }}.azurecontainerapps.io
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
